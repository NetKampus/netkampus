name: board automations
on:
  issues:
    types: [opened, assigned]
  pull_request:
    types: [opened, ready_for_review, converted_to_draft, reopened]

jobs:
  # ----------------------------------------------------------------
  # Case 1: Issue -> Ready
  # Cover: issue assigned OR issue opened with assignees
  # ----------------------------------------------------------------
  issue_to_ready:
    # Logic: It's an issue AND (just assigned OR (just opened AND has assignees))
    if: >
      github.event_name == 'issues' &&
      (
        github.event.action == 'assigned' ||
        (github.event.action == 'opened' && toJson(github.event.issue.assignees) != '[]')
      )
    runs-on: ubuntu-latest
    steps:
      - name: Move linked Issue to Ready
        uses: leonsteinhaeuser/project-beta-automations@v2.2.1
        with:
          gh_token: ${{ secrets.PROJECT_TOKEN }}
          organization: NetKampus
          project_id: 5
          resource_node_id: ${{ github.event.issue.node_id }}
          operation_mode: status
          status_value: "Ready"

  # ----------------------------------------------------------------
  # Case 2: PR Draft -> Issue to In Progress
  # ----------------------------------------------------------------
  pr_move_linked_issues_only:
    if: github.event_name == 'pull_request' && github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Move linked issues (do NOT add PR to Project)
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.PROJECT_TOKEN }}
          script: |
            const ORG = "NetKampus";
            const PROJECT_NUMBER = 5;
            const STATUS_FIELD = "Status";

            const pr = context.payload.pull_request;

            // Draft -> In progress ; No draft -> In review
            const targetStatus = pr.draft ? "In progress" : "In review";

            // Extrae: Closes/Fixes/Resolves
            function extractIssueNumbers(text) {
              const re = /(close[sd]?|fix(e[sd])?|resolve[sd]?)\s*[: ]+\s*(?:[A-Za-z0-9_.-]+\/[A-Za-z0-9_.-]+)?#(\d+)/ig;
              const out = new Set();
              let m;
              while ((m = re.exec(text || "")) !== null) out.add(Number(m[3]));
              return [...out];
            }

            const issueNums = extractIssueNumbers(pr.body);
            if (!issueNums.length) return;

            // Project meta (id + Status field + option ids)
            const meta = await github.graphql(`
              query($org: String!, $n: Int!) {
                organization(login: $org) {
                  projectV2(number: $n) {
                    id
                    fields(first: 100) {
                      nodes {
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options { id name }
                        }
                      }
                    }
                  }
                }
              }`, { org: ORG, n: PROJECT_NUMBER });

            const project = meta.organization.projectV2;
            const statusField = project.fields.nodes.find(f => f.name === STATUS_FIELD);
            const opt = statusField.options.find(o => o.name === targetStatus);

            // Mutations: add issue to project (si no estÃ¡) + update Status
            const addItem = `
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(input: { projectId: $projectId, contentId: $contentId }) {
                  item { id }
                }
              }`;

            const updateStatus = `
              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                updateProjectV2ItemFieldValue(input: {
                  projectId: $projectId,
                  itemId: $itemId,
                  fieldId: $fieldId,
                  value: { singleSelectOptionId: $optionId }
                }) { projectV2Item { id } }
              }`;

            for (const num of issueNums) {
              const issue = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: num
              });

              if (issue.data.pull_request) continue;

              const issueNodeId = issue.data.node_id;

              // Add (idempotente) -> obtiene itemId
              const added = await github.graphql(addItem, {
                projectId: project.id,
                contentId: issueNodeId
              });

              const itemId = added.addProjectV2ItemById.item.id;

              await github.graphql(updateStatus, {
                projectId: project.id,
                itemId,
                fieldId: statusField.id,
                optionId: opt.id
              });
            }
